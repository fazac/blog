<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/common::admin-header-link"></head>

<body>
<div class="container-fluid">
    <div class="row">
        <div th:replace="admin/common::admin-side-bar"></div>
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
            <div th:replace="admin/common::admin-head-nav"></div>
            <div class="row col-md-9 pt-4">
                <a class="btn btn-success" href="/admin/createBlog">新增</a>
                <a class="btn btn-info ml-5" id="_modify">修改</a>
                <button data-toggle="modal" data-target="#confirm_model"
                        data-title="发布确认" data-desc="确认发布所选文章"
                        data-action="publicBlogs"
                        class="btn btn-info ml-5">发布
                </button>
                <button data-toggle="modal" data-target="#confirm_model"
                        data-title="删除确认" data-desc="确认删除所选文章"
                        data-action="deleteBlogs"
                        class="btn btn-danger ml-5">删除
                </button>
            </div>
            <div class="table-responsive pt-2">
                <table id="blog_table" class="table stripe compact hover">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="_all_select"/></th>
                        <th>标题</th>
                        <th>分类</th>
                        <th>摘要</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>发布时间</th>
                        <th>修改时间</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!--                    <tr th:each="blog :${blogs.records}">-->
                    <!--                        <td><input type="checkbox" data-th-id="${blog.blogId}"/></td>-->
                    <!--                        <td th:text="${blog.title}"></td>-->
                    <!--                        <td th:text="${blog.digest}"></td>-->
                    <!--                        <td th:text="${blog.status}"></td>-->
                    <!--                        <td th:text="${#dates.format(blog.createTime,'yyyy-MM-dd')}"></td>-->
                    <!--                        <td th:text="${#dates.format(blog.publishTime,'yyyy-MM-dd')}"></td>-->
                    <!--                        <td th:text="${#dates.format(blog.updateTime,'yyyy-MM-dd')}"></td>-->
                    <!--                    </tr>-->
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>
<div th:include="admin/common::admin-footer"></div>
</body>
<script type="text/javascript">
    "use strict";

    let dtsLanguage = "/static/ui/language/dtsLanguage.txt"
    let dt;
    $(document).ready(function () {
        dt = $("#blog_table").DataTable({
            serverSide: true,
            destroy: true,
            bLengthChange: false,
            bAutoWidth: false,
            bInfo: true,
            order: [6, "desc"],
            language: {
                url: dtsLanguage
            },
            columns: [
                {
                    data: null, searchable: false, width: '10px',
                    render: function (data, type, full, meta) {
                        return " <input type='checkbox' data-id='" + full.blogId + "'/>";
                    }
                },
                {data: 'title', width: '100px'},
                {data: 'labelidsName', width: '100px', searchable: false, orderable: false},
                {data: 'digest', width: '250px'},
                {
                    data: 'status', width: '40px',
                    render: function (data, type, full, meta) {
                        if ('CREATE' === data.trim()) {
                            return '未发布';
                        } else {
                            return '已发布';
                        }
                    }
                },
                {
                    name: 'create_time', width: '80px',
                    data: 'createTime',
                },
                {
                    name: 'publish_time', width: '80px',
                    data: 'publishTime',
                },
                {
                    name: 'update_time', width: '80px',
                    data: 'updateTime',
                },
            ],
            columnDefs: [
                {
                    targets: [0],
                    orderable: false,
                }, {
                    defaultContent: '',
                    targets: ['_all'],
                }
            ],
            ajax: function (data, callback, setting) {
                if (data.search.value.trim().length > 0) {
                    data.search.value = data.search.value.replaceAll("未发布", "CREATE");
                    data.search.value = data.search.value.replaceAll("已发布", "PUBLISH");
                }
                $.ajax({
                    url: "/admin/getBlogs",
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify(data),
                    success: function (res) {
                        callback(res.detail.bizData);
                    },
                })
            },
            createdRow: function (row, data, index) {
                $('td', row).attr("class", "text-center");
                let digist = $('td:nth-child(4)', row);
                digist.attr("class", "text-left table-cell");
                digist.prop("title", data['digest']);
            },

        });
    });

    function deleteBlogs(ids) {
        if (ids.length === 0) {
            $("#confirm_model").modal("hide");
            tipMsg("未选择文章");
        } else {
            $.get("/admin/deleteBlogs", {
                ids: ids.join(','),
            }, function (res) {
                console.log(res);
                $("#confirm_model").modal("hide");
                dt.ajax.reload();
                if (res.detail.bizData === true) {
                    tipMsg("删除成功");
                } else {
                    tipMsg("删除失败");
                }
            });
        }

    }

    function publicBlogs(ids) {
        if (ids.length === 0) {
            $("#confirm_model").modal("hide");
            tipMsg("未选择文章");
        } else {
            $.get("/admin/publishBlogs", {
                ids: ids.join(','),
            }, function (res) {
                $("#confirm_model").modal("hide");
                dt.ajax.reload();
                if (res.detail.bizData === true) {
                    tipMsg("发布成功");
                } else {
                    tipMsg("发布失败");
                }
            });
        }
    }

    $(function () {
        $("#_modify").click(function () {
            let checkedIds = $(":checked:not(#_all_select)");
            if (checkedIds.length === 1) {
                window.location.href = "/admin/editBlog?id=" + $(checkedIds[0]).data('id');
            } else if (checkedIds.length > 1) {
                tipMsg("只能选择一篇文章修改");
            } else if (checkedIds.length === 0) {
                tipMsg("需选择一篇文章修改");
            }
            // else {
            // $.get("/admin/editBlog", {id: $(checkedIds[0]).data('id')}, function (res) {
            //     // console.log(res);
            //     // window.location.href = res.detail.biz_message;
            // });
            // }
        });

        $("#_model_confirm").on("click", confirmButtonClick());

        $("#_all_select").click(function () {
            if ($(this).prop("checked")) {
                $(":checkbox").attr("checked", true);
            } else {
                $(":checkbox").attr("checked", false);
            }
        });
    });
</script>
</html>